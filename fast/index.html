<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DB Chat — FastAPI Connector</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Markdown + sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .msg pre { @apply bg-gray-100 p-2 rounded-md text-sm overflow-auto; }
    .msg-agent { font-family: 'Ubuntu', sans-serif; }
    .msg-user { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gradient-to-r from-gray-50 via-white to-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-3xl h-[90vh] flex flex-col bg-white shadow-2xl rounded-2xl overflow-hidden border border-gray-200">
    <header class="px-6 py-4 border-b border-gray-200 flex items-center gap-3 bg-gradient-to-r from-blue-50 to-blue-100">
      <i class="fa-solid fa-database text-blue-600 text-xl"></i>
      <div>
        <h1 class="text-lg font-bold text-blue-700 tracking-tight">DB Chat</h1>
        <p class="text-sm text-gray-600">Ask your database in plain English or SQL</p>
      </div>
      <button id="clear" class="ml-auto px-3 py-1.5 text-sm border rounded-lg text-gray-600 hover:bg-gray-200 transition" title="Clear conversation">
        <i class="fa-regular fa-trash-can"></i> Clear
      </button>
    </header>

    <div id="messages" class="flex-1 overflow-auto p-6 space-y-4 bg-gray-50"></div>

    <div class="px-6 py-2 border-t border-dashed border-gray-200 text-xs text-gray-500 italic">
      Type SQL/English question. Press Enter to send. Responses rendered as Markdown.
    </div>

    <div class="p-4 border-t border-gray-200 flex gap-2 items-end bg-white">
      <div class="flex-1 flex items-center bg-gray-100 border border-gray-300 rounded-xl px-3 py-2">
        <textarea id="input" placeholder="Ask: top 2 users with most payments..." class="flex-1 bg-transparent resize-none outline-none text-sm p-1 font-inter" rows="1"></textarea>
      </div>
      <button id="send" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-medium flex items-center gap-2 transition">
        <i class="fa-solid fa-paper-plane"></i> Send
      </button>
    </div>
  </div>

  <script>
    const API_URL = "http://127.0.0.1:8000/query";
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');

    function appendMessage(role, contentHTML) {
      const base = document.createElement('div');
      if (role === 'user') {
        base.className = 'msg-user max-w-[75%] px-4 py-3 rounded-2xl shadow-sm whitespace-pre-wrap text-sm ml-auto bg-blue-500 text-white flex items-center gap-2';
        base.innerHTML = `<i class='fa-solid fa-user'></i>${contentHTML}`;
      } else {
        base.className = 'msg-agent max-w-[75%] px-4 py-3 rounded-2xl shadow-sm whitespace-pre-wrap text-sm mr-auto bg-gray-200 text-gray-800 flex items-center gap-2';
        base.innerHTML = `<i class='fa-solid fa-robot text-gray-600'></i>${contentHTML}`;
      }
      messagesEl.appendChild(base);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function renderMarkdown(md) {
      const unsafe = marked.parse(md ?? "");
      return DOMPurify.sanitize(unsafe);
    }

    async function sendQuery(query) {
      appendMessage('user', query);
      const loader = document.createElement('div');
      loader.className = 'msg-agent mr-auto flex items-center gap-2 text-gray-400 text-sm';
      loader.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Thinking…';
      messagesEl.appendChild(loader);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_query: query })
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);

        const j = await res.json();
        let out = (j.response ?? j.result ?? j.data ?? JSON.stringify(j));

        loader.remove();
        appendMessage('bot', `<span style='font-family:Ubuntu, sans-serif'>${renderMarkdown(typeof out === 'string' ? out : JSON.stringify(out, null, 2))}</span>`);
      } catch (err) {
        loader.remove();
        appendMessage('bot', `<span style='font-family:Ubuntu, sans-serif'>${renderMarkdown("Error: `" + err.message + "`")}</span>`);
      }
    }

    sendBtn.addEventListener('click', () => {
      const q = inputEl.value.trim();
      if (!q) return;
      inputEl.value = '';
      sendQuery(q);
      inputEl.focus();
    });

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    clearBtn.addEventListener('click', () => {
      messagesEl.innerHTML = '';
      inputEl.focus();
    });

    appendMessage('bot', `<span style='font-family:Ubuntu, sans-serif'><i class='fa-solid fa-robot text-gray-600'></i> ${renderMarkdown("Welcome. Try: `Give me the top 2 users that have made most payment and collective payment amount`")}</span>`);
    inputEl.focus();
  </script>
</body>
</html>
